name: Blob storage website CI

on:
    push:
        branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: azure/login@v2
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy infrastructure
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az deployment group create --resource-group ${{ secrets.RESOURCE_GROUP }} --template-file infrastructure/main.bicep --parameters storageAccountName=${{ secrets.STORAGE_ACCOUNT_NAME }} cdnProfileName=${{ secrets.CDN_PROFILE_NAME }} cdnEndpointName=${{ secrets.CDN_ENDPOINT_NAME }} cdnEndpointOriginHostHeader=${{ secrets.STORAGE_ACCOUNT_NAME }}.z13.web.core.windows.net

    - name: Update to blob storage
      uses: azure/CLI@v1
      with:
        inlineScript: |
            az storage blob upload-batch --account-name ${{ secrets.STORAGE_ACCOUNT_NAME }} --destination '$web' --source . --overwrite
    - name: Purge CDN endpoint
      uses: azure/CLI@v1
      with:
        inlineScript: |
           az cdn endpoint purge --content-paths  "/*" --profile-name ${{ secrets.CDN_PROFILE_NAME }} --name ${{ secrets.CDN_ENDPOINT_NAME }} --resource-group ${{ secrets.RESOURCE_GROUP }}

    - name: Deploy Azure Function
      uses: azure/CLI@v1
      with:
        inlineScript: |
          az functionapp deployment source config-zip --resource-group ${{ secrets.RESOURCE_GROUP }} --name ${{ secrets.FUNCTION_APP_NAME }} --src-path function_app.zip

  # Azure logout
    - name: logout
      run: |
            az logout
      if: always()
